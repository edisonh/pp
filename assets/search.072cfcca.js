import{d as ee,r as p,m as te,l as se,p as ae,ab as le,n as ie,o as ne,b as F,s as E,E as _,e as l,f as a,aq as oe,w as n,ad as ue,M as ce,F as b,D,R as re,ay as de,Q as w,c as fe,y as d,A as he,a9 as pe,ag as _e,a7 as ve,I as B,ah as ge,aj as ye,P as ke,U as c,a8 as I,ar as me}from"./vendor.54f6d311.js";import{i as f,b as Fe}from"./index.b16161ef.js";const we={class:"list-page list-page-files"},Ce={class:"header"},Ee={class:"search"},be=d(" \u641C\u7D22 "),De={class:"action"},Be=d(" \u68C0\u67E5\u91CD\u590D\u6587\u4EF6 "),Ne=d("\u91CD\u65B0\u626B\u63CF"),Se={key:0,class:"loading"},xe=d("\u52A0\u8F7D\u4E2D "),Ae={key:0,class:"outer-wrapper static show"},$e={class:"toolbar-wrapper"},Re=d(" \u526A\u5207\u6240\u9009 "),ze=d(" \u6279\u91CF\u4E0B\u8F7D "),Ie=d(" \u5220\u9664\u6240\u9009 "),Te=ee({setup(Me){const h=p(),M=te();se();const u=p([]);ae();const L=p(!1),k=p(),N=le(),v=p(),S=p("");let C=null;const P=p([{type:"selection"},{title:"\u540D\u79F0",key:"name",sorter:"default",render:e=>c("div",{class:"file-info"},[c("img",{src:e.thumbnail_link||e.icon_link}),c(I,{class:"title"},[c("span",{},String(e.name)),e.exist?c("a",{style:"color: #306eff; text-decoration: underline; float: right;",target:"_blank",href:e.exist.url,onClick:me(()=>{},["stop"])},[e.exist.filename,c("span",{style:"color:red"},e.exist.size)]):c("span")]),c("span",{class:"action"},"1")])},{title:"\u5927\u5C0F",key:"size",sorter:(e,s)=>e.size-s.size,align:"right",render:e=>Number(e.size)>0?Fe(Number(e.size)):"",className:"size",width:100},{title:"\u8DEF\u5F84",key:"path",sorter:"default",render:e=>c("div",{class:"file-info"},[c("img",{src:e.icon_link}),c(I,{class:"title"},{default:()=>String(e.path)})])}]),x=()=>{k.value=JSON.parse(window.localStorage.getItem("pikpakMoveFiles")||"[]"),h.value=[],u.value=[]};ie(M,()=>{x()}),ne(()=>{x()});const T=e=>{e.target.offsetHeight+e.target.scrollTop>=e.target.scrollHeight-30},O=e=>{let s=[];h.value.forEach(t=>{if(u.value.indexOf(t.id)!==-1)s.push(t.id);else if(t.children)for(let i in t.children)u.value.indexOf(t.children[i].id)!==-1&&s.push(t.children[i].id)}),j(s),u.value=[]},j=e=>{k.value=e,window.localStorage.setItem("pikpakMoveFiles",JSON.stringify(e)),window.$message.success("\u526A\u5207\u6210\u529F\uFF0C\u8BF7\u70B9\u51FB\u9875\u9762\u53F3\u4E0A\u65B9\u7C98\u8D34\u6309\u94AE")},H=e=>{f.post("https://api-drive.mypikpak.com/drive/v1/files:batchTrash",{ids:typeof e=="string"?[e]:e}).then(()=>{K(typeof e=="string"?[e]:e),window.$message.success("\u5220\u9664\u6210\u529F"),u.value=[],C&&C()})},V=async()=>{const e=async o=>await f.get("https://api-drive.mypikpak.com/drive/v1/files/"+o,{params:{_magic:"2021",thumbnail_size:"SIZE_LARGE"}}),s=async()=>{const o=JSON.parse(JSON.stringify(u.value)),r=new Set;for(let y in h.value)h.value[y].kind==="drive#folder"&&r.add(h.value[y].id);const R=[];for(let y in o){if(r.has(o[y]))continue;const z=await e(o[y]);R.push({url:z.data.web_content_link,filename:z.data.name})}return R},t=o=>{const r="chrome_extension_id";chrome.runtime.sendMessage(r,{msg:"pikpak_batch_download",items:o})};v.value=N.create({title:"\u6279\u91CF\u4E0B\u8F7D\u6587\u4EF6",closable:!0,content:"\u6B63\u5728\u83B7\u53D6\u6587\u4EF6\u5217\u8868..."});const i=await s();u.value=[],v.value.content="\u5171\u83B7\u53D6\u5230"+i.length+"\u4E2A\u6587\u4EF6",t(i)},q=async()=>{},A=async()=>{h.value=await Z(),C=A},J=async(e,s,t)=>{const i={phase:{eq:"PHASE_TYPE_COMPLETE"},trashed:{eq:!1}};return(await f.get("https://api-drive.mypikpak.com/drive/v1/files",{params:{parent_id:e,limit:s,filters:i,thumbnail_size:"SIZE_LARGE",with_audit:!0,page_token:t||void 0}})).data},U=async e=>{const s=100;let t="",i=[];for(let o=0;o<10;o++){const r=await J(e,s,t);if(i=i.concat(r.files),r.files.length<s||!r.next_page_token)break;t=r.next_page_token}return i},g="http://localhost:3000/pikpak",G=async(e,s)=>{await f.post(`${g}/files`,{parentIds:e,files:s})},Z=async()=>(await f.get(`${g}/files/redundancy`)).data,K=async e=>{await f.get(`${g}/delete/files/${e.join(",")}`)},Q=async e=>(await f.get(`${g}/file/${e}`)).data,X=async e=>{await f.get(`${g}/file/scanned/${e}`)},Y=async e=>new Promise((s,t)=>{setTimeout(()=>{s()},e)}),$=async e=>{const s=e[e.length-1],t=await U(s);await G(e,t);for(let i=0;i<t.length;i++)t[i].kind=="drive#folder"&&((await Q(t[i].id)).scanned||(await Y(2e3),await $(e.concat([t[i].id])))),e.length==1&&m(`\u5DF2\u626B\u63CF${Math.floor((i+1)/t.length*100)}%(${i+1}/${t.length})...`);s!=""&&await X(s)},m=async e=>{v.value&&v.value.destroy(),v.value=N.info({title:e})},W=async()=>{m("\u5F00\u59CB\u626B\u63CF\u5168\u76D8...");try{await $([""]),m("\u626B\u63CF\u5B8C\u6210")}catch(e){m("\u626B\u63CF\u51FA\u9519: "+e)}};return(e,s)=>(F(),E("div",we,[_("div",Ce,[_("div",Ee,[l(a(oe),null,{default:n(()=>[l(a(re),{placeholder:"\u6587\u4EF6\u540D\u3001hash",value:S.value,"onUpdate:value":s[0]||(s[0]=t=>S.value=t)},{prefix:n(()=>[l(a(de))]),_:1},8,["value"]),l(a(w),{type:"primary",ghost:"",onClick:q},{default:n(()=>[be]),_:1})]),_:1})]),_("div",De,[l(a(ue),null,{default:n(()=>{var t;return[((t=k.value)==null?void 0:t.length)?(F(),fe(a(w),{key:0,type:"default"},{default:n(()=>[d(" \u7C98\u8D34\u5DF2\u526A\u5207"+he(k.value.length)+"\u9879\u8D44\u6E90 ",1)]),_:1})):D("",!0),l(a(w),{onClick:A},{default:n(()=>[Be]),_:1}),l(a(pe),{onPositiveClick:W},{trigger:n(()=>[l(a(w),null,{default:n(()=>[Ne]),_:1})]),_:1})]}),_:1})])]),l(a(ce),{style:{"max-height":"calc(100vh - 190px)"},onScroll:T},{default:n(()=>[l(a(_e),{"checked-row-keys":u.value,"onUpdate:checked-row-keys":s[1]||(s[1]=t=>u.value=t),"row-key":t=>t.id,data:h.value,size:"small",columns:P.value,bordered:!1},null,8,["checked-row-keys","row-key","data","columns"]),L.value?(F(),E("div",Se,[l(a(ve),{size:"small"}),xe])):D("",!0)]),_:1}),u.value.length?(F(),E("div",Ae,[_("div",$e,[_("div",{class:"toolbar-item",onClick:O},[l(a(b),null,{trigger:n(()=>[l(a(B),null,{default:n(()=>[l(a(ge))]),_:1})]),default:n(()=>[Re]),_:1})]),_("div",{class:"toolbar-item",onClick:V},[l(a(b),null,{trigger:n(()=>[l(a(B),null,{default:n(()=>[l(a(ye))]),_:1})]),default:n(()=>[ze]),_:1})]),_("div",{class:"toolbar-item",onClick:s[2]||(s[2]=t=>H(u.value))},[l(a(b),null,{trigger:n(()=>[l(a(B),null,{default:n(()=>[l(a(ke))]),_:1})]),default:n(()=>[Ie]),_:1})])])])):D("",!0)]))}});export{Te as default};
