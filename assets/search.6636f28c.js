import{d as Q,r as f,m as X,l as Y,p as W,ab as ee,n as te,o as se,b as m,s as C,E as h,e as i,f as a,aq as ae,w as n,ad as le,M as ie,F as E,D as b,R as ne,ay as oe,Q as F,c as ue,y as d,A as ce,ag as re,a7 as de,I as D,ah as fe,aj as he,P as pe,U as u,a8 as I,ar as _e}from"./vendor.54f6d311.js";import{i as _,b as ve}from"./index.7921b4c8.js";const ge={class:"list-page list-page-files"},ke={class:"header"},ye={class:"search"},me=d(" \u641C\u7D22 "),Fe={class:"action"},we=d(" \u68C0\u67E5\u91CD\u590D\u6587\u4EF6 "),Ce=d(" \u91CD\u65B0\u626B\u63CF "),Ee={key:0,class:"loading"},be=d("\u52A0\u8F7D\u4E2D "),De={key:0,class:"outer-wrapper static show"},Be={class:"toolbar-wrapper"},Se=d(" \u526A\u5207\u6240\u9009 "),xe=d(" \u6279\u91CF\u4E0B\u8F7D "),Ne=d(" \u5220\u9664\u6240\u9009 "),Me=Q({setup(Ae){const p=f(),M=X();Y();const c=f([]);W();const R=f(!1),k=f(),B=ee(),v=f(),S=f(""),$=f([{type:"selection"},{title:"\u540D\u79F0",key:"name",sorter:"default",render:e=>u("div",{class:"file-info"},[u("img",{src:e.thumbnail_link||e.icon_link}),u(I,{class:"title"},[u("span",{},String(e.name)),e.exist?u("a",{style:"color: #306eff; text-decoration: underline; float: right;",target:"_blank",href:e.exist.url,onClick:_e(()=>{},["stop"])},[e.exist.filename,u("span",{style:"color:red"},e.exist.size)]):u("span")]),u("span",{class:"action"},"1")])},{title:"\u5927\u5C0F",key:"size",sorter:(e,s)=>e.size-s.size,align:"right",render:e=>Number(e.size)>0?ve(Number(e.size)):"",className:"size",width:100},{title:"\u8DEF\u5F84",key:"path",sorter:"default",render:e=>u("div",{class:"file-info"},[u("img",{src:e.icon_link}),u(I,{class:"title"},{default:()=>String(e.name)}),u("span",{class:"action"},"1")])}]),x=()=>{k.value=JSON.parse(window.localStorage.getItem("pikpakMoveFiles")||"[]"),p.value=[],c.value=[]};te(M,()=>{x()}),se(()=>{x()});const L=e=>{e.target.offsetHeight+e.target.scrollTop>=e.target.scrollHeight-30},O=e=>{let s=[];p.value.forEach(t=>{if(c.value.indexOf(t.id)!==-1)s.push(t.id);else if(t.children)for(let l in t.children)c.value.indexOf(t.children[l].id)!==-1&&s.push(t.children[l].id)}),T(s),c.value=[]},T=e=>{k.value=e,window.localStorage.setItem("pikpakMoveFiles",JSON.stringify(e)),window.$message.success("\u526A\u5207\u6210\u529F\uFF0C\u8BF7\u70B9\u51FB\u9875\u9762\u53F3\u4E0A\u65B9\u7C98\u8D34\u6309\u94AE")},P=e=>{_.post("https://api-drive.mypikpak.com/drive/v1/files:batchTrash",{ids:typeof e=="string"?[e]:e}).then(()=>{window.$message.success("\u5220\u9664\u6210\u529F"),c.value=[]})},H=async()=>{const e=async o=>await _.get("https://api-drive.mypikpak.com/drive/v1/files/"+o,{params:{_magic:"2021",thumbnail_size:"SIZE_LARGE"}}),s=async()=>{const o=JSON.parse(JSON.stringify(c.value)),r=new Set;for(let g in p.value)p.value[g].kind==="drive#folder"&&r.add(p.value[g].id);const A=[];for(let g in o){if(r.has(o[g]))continue;const z=await e(o[g]);A.push({url:z.data.web_content_link,filename:z.data.name})}return A},t=o=>{const r="chrome_extension_id";chrome.runtime.sendMessage(r,{msg:"pikpak_batch_download",items:o})};v.value=B.create({title:"\u6279\u91CF\u4E0B\u8F7D\u6587\u4EF6",closable:!0,content:"\u6B63\u5728\u83B7\u53D6\u6587\u4EF6\u5217\u8868..."});const l=await s();c.value=[],v.value.content="\u5171\u83B7\u53D6\u5230"+l.length+"\u4E2A\u6587\u4EF6",t(l)},V=async()=>{},q=async()=>{},J=async(e,s,t)=>{const l={phase:{eq:"PHASE_TYPE_COMPLETE"},trashed:{eq:!1}};return(await _.get("https://api-drive.mypikpak.com/drive/v1/files",{params:{parent_id:e,limit:s,filters:l,thumbnail_size:"SIZE_LARGE",with_audit:!0,page_token:t||void 0}})).data},U=async e=>{const s=100;let t="",l=[];for(let o=0;o<10;o++){const r=await J(e,s,t);if(l=l.concat(r.files),r.files.length<s||!r.next_page_token)break;t=r.next_page_token}return l},w="http://localhost:3000/pikpak",j=async(e,s)=>{await _.post(`${w}/files`,{parentIds:e,files:s})},G=async e=>(await _.get(`${w}/file/${e}`)).data,Z=async e=>{await _.get(`${w}/file/scanned/${e}`)},N=async e=>{const s=e[e.length-1],t=await U(s);await j(e,t);for(let l=0;l<t.length;l++)t[l].kind=="drive#folder"&&((await G(t[l].id)).scanned||await N(e.concat([t[l].id]))),e.length==1&&y(`\u5DF2\u626B\u63CF${Math.floor((l+1)/t.length*100)}%(${l+1}/${t.length})...`);s!=""&&await Z(s)},y=async e=>{v.value&&v.value.destroy(),v.value=B.info({title:e})},K=async()=>{y("\u5F00\u59CB\u626B\u63CF\u5168\u76D8...");try{await N([""]),y("\u626B\u63CF\u5B8C\u6210")}catch(e){y("\u626B\u63CF\u51FA\u9519: "+e)}};return(e,s)=>(m(),C("div",ge,[h("div",ke,[h("div",ye,[i(a(ae),null,{default:n(()=>[i(a(ne),{placeholder:"\u6587\u4EF6\u540D\u3001hash",value:S.value,"onUpdate:value":s[0]||(s[0]=t=>S.value=t)},{prefix:n(()=>[i(a(oe))]),_:1},8,["value"]),i(a(F),{type:"primary",ghost:"",onClick:V},{default:n(()=>[me]),_:1})]),_:1})]),h("div",Fe,[i(a(le),null,{default:n(()=>{var t;return[((t=k.value)==null?void 0:t.length)?(m(),ue(a(F),{key:0,type:"default"},{default:n(()=>[d(" \u7C98\u8D34\u5DF2\u526A\u5207"+ce(k.value.length)+"\u9879\u8D44\u6E90 ",1)]),_:1})):b("",!0),i(a(F),{onClick:q},{default:n(()=>[we]),_:1}),i(a(F),{onClick:K},{default:n(()=>[Ce]),_:1})]}),_:1})])]),i(a(ie),{style:{"max-height":"calc(100vh - 190px)"},onScroll:L},{default:n(()=>[i(a(re),{"checked-row-keys":c.value,"onUpdate:checked-row-keys":s[1]||(s[1]=t=>c.value=t),"row-key":t=>t.id,data:p.value,size:"small",columns:$.value,bordered:!1},null,8,["checked-row-keys","row-key","data","columns"]),R.value?(m(),C("div",Ee,[i(a(de),{size:"small"}),be])):b("",!0)]),_:1}),c.value.length?(m(),C("div",De,[h("div",Be,[h("div",{class:"toolbar-item",onClick:O},[i(a(E),null,{trigger:n(()=>[i(a(D),null,{default:n(()=>[i(a(fe))]),_:1})]),default:n(()=>[Se]),_:1})]),h("div",{class:"toolbar-item",onClick:H},[i(a(E),null,{trigger:n(()=>[i(a(D),null,{default:n(()=>[i(a(he))]),_:1})]),default:n(()=>[xe]),_:1})]),h("div",{class:"toolbar-item",onClick:s[2]||(s[2]=t=>P(c.value))},[i(a(E),null,{trigger:n(()=>[i(a(D),null,{default:n(()=>[i(a(pe))]),_:1})]),default:n(()=>[Ne]),_:1})])])])):b("",!0)]))}});export{Me as default};
