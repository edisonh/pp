import{d as ae,r as p,m as se,l as ne,p as le,ab as ie,n as oe,o as ue,b as C,s as D,E as v,e as n,f as s,as as ce,w as i,ad as re,M as de,F as b,D as B,R as fe,aA as he,Q as F,c as _e,y as h,A as pe,a9 as ve,ag as ge,a7 as ye,I as N,ah as ke,ak as Fe,P as me,U as c,a8 as L,at as we}from"./vendor.b04d76c4.js";import{i as d,b as Ce}from"./index.8c88dc03.js";const Ee={class:"list-page list-page-files"},De={class:"header"},be={class:"search"},Be=h(" \u641C\u7D22 "),Ne={class:"action"},Se=h(" \u68C0\u67E5\u672A\u4E0B\u8F7D\u6587\u4EF6 "),xe=h(" \u68C0\u67E5\u91CD\u590D\u6587\u4EF6 "),Ae=h("\u91CD\u65B0\u626B\u63CF"),$e={key:0,class:"loading"},Re=h("\u52A0\u8F7D\u4E2D "),Ie={key:0,class:"outer-wrapper static show"},ze={class:"toolbar-wrapper"},Me=h(" \u526A\u5207\u6240\u9009 "),Le=h(" \u6279\u91CF\u4E0B\u8F7D "),Oe=h(" \u5220\u9664\u6240\u9009 "),He=ae({setup(Pe){const f=p(),O=se();ne();const u=p([]);le();const P=p(!1),m=p(),S=ie(),g=p(),E=p("");let y=null;const T=p([{type:"selection"},{title:"\u540D\u79F0",key:"name",sorter:"default",render:e=>c("div",{class:"file-info"},[c("img",{src:e.thumbnail_link||e.icon_link}),c(L,{class:"title"},[c("span",{},String(e.name)),e.exist?c("a",{style:"color: #306eff; text-decoration: underline; float: right;",target:"_blank",href:e.exist.url,onClick:we(()=>{},["stop"])},[e.exist.filename,c("span",{style:"color:red"},e.exist.size)]):c("span")]),c("span",{class:"action"},"1")])},{title:"\u5927\u5C0F",key:"size",sorter:(e,a)=>e.size-a.size,align:"right",render:e=>Number(e.size)>0?Ce(Number(e.size)):"",className:"size",width:100},{title:"\u8DEF\u5F84",key:"path",sorter:"default",render:e=>c("div",{class:"file-info"},[c("img",{src:e.icon_link}),c(L,{class:"title"},{default:()=>String(e.path)})])}]),x=()=>{m.value=JSON.parse(window.localStorage.getItem("pikpakMoveFiles")||"[]"),f.value=[],u.value=[]};oe(O,()=>{x()}),ue(()=>{x()});const U=e=>{e.target.offsetHeight+e.target.scrollTop>=e.target.scrollHeight-30},H=e=>{let a=[];f.value.forEach(t=>{if(u.value.indexOf(t.id)!==-1)a.push(t.id);else if(t.children)for(let l in t.children)u.value.indexOf(t.children[l].id)!==-1&&a.push(t.children[l].id)}),V(a),u.value=[]},V=e=>{m.value=e,window.localStorage.setItem("pikpakMoveFiles",JSON.stringify(e)),window.$message.success("\u526A\u5207\u6210\u529F\uFF0C\u8BF7\u70B9\u51FB\u9875\u9762\u53F3\u4E0A\u65B9\u7C98\u8D34\u6309\u94AE")},q=e=>{d.post("https://api-drive.mypikpak.com/drive/v1/files:batchTrash",{ids:typeof e=="string"?[e]:e}).then(()=>{Q(typeof e=="string"?[e]:e),window.$message.success("\u5220\u9664\u6210\u529F"),u.value=[],y&&y()})},J=async()=>{const e=async o=>await d.get("https://api-drive.mypikpak.com/drive/v1/files/"+o,{params:{_magic:"2021",thumbnail_size:"SIZE_LARGE"}}),a=async()=>{const o=JSON.parse(JSON.stringify(u.value)),r=new Set;for(let k in f.value)f.value[k].kind==="drive#folder"&&r.add(f.value[k].id);const z=[];for(let k in o){if(r.has(o[k]))continue;const M=await e(o[k]);z.push({url:M.data.web_content_link,filename:M.data.name})}return z},t=o=>{const r="chrome_extension_id";chrome.runtime.sendMessage(r,{msg:"pikpak_batch_download",items:o})};g.value=S.create({title:"\u6279\u91CF\u4E0B\u8F7D\u6587\u4EF6",closable:!0,content:"\u6B63\u5728\u83B7\u53D6\u6587\u4EF6\u5217\u8868..."});const l=await a();u.value=[],g.value.content="\u5171\u83B7\u53D6\u5230"+l.length+"\u4E2A\u6587\u4EF6",t(l)},A=async()=>{f.value=await X("name",E.value),y=A},$=async()=>{f.value=await K(),y=$},j=async(e,a,t)=>{const l={phase:{eq:"PHASE_TYPE_COMPLETE"},trashed:{eq:!1}};return(await d.get("https://api-drive.mypikpak.com/drive/v1/files",{params:{parent_id:e,limit:a,filters:l,thumbnail_size:"SIZE_LARGE",with_audit:!0,page_token:t||void 0}})).data},G=async e=>{const a=100;let t="",l=[];for(let o=0;o<10;o++){const r=await j(e,a,t);if(l=l.concat(r.files),r.files.length<a||!r.next_page_token)break;t=r.next_page_token}return l},_="http://localhost:3000/pikpak",Z=async(e,a)=>{await d.post(`${_}/files`,{parentIds:e,files:a})},K=async()=>(await d.get(`${_}/files/redundancy`)).data,R=async()=>(await d.get(`${_}/files/undownloaded`)).data,Q=async e=>{await d.get(`${_}/delete/files/${e.join(",")}`)},X=async(e,a)=>(await d.get(`${_}/files/${e}/${encodeURIComponent(a)}`)).data,Y=async e=>(await d.get(`${_}/file/${e}`)).data,W=async e=>{await d.get(`${_}/file/scanned/${e}`)},I=async e=>{const a=e[e.length-1],t=await G(a);await Z(e,t);for(let l=0;l<t.length;l++)t[l].kind=="drive#folder"&&((await Y(t[l].id)).scanned||await I(e.concat([t[l].id]))),e.length==1&&w(`\u5DF2\u626B\u63CF${Math.floor((l+1)/t.length*100)}%(${l+1}/${t.length})...`);a!=""&&await W(a)},w=async e=>{if(g.value)try{g.value.destroy()}catch{}g.value=S.info({title:e})},ee=async()=>{w("\u5F00\u59CB\u626B\u63CF\u5168\u76D8...");try{await I([""]),w("\u626B\u63CF\u5B8C\u6210")}catch(e){w("\u626B\u63CF\u51FA\u9519: "+e)}},te=async()=>{f.value=await R(),y=R};return(e,a)=>(C(),D("div",Ee,[v("div",De,[v("div",be,[n(s(ce),null,{default:i(()=>[n(s(fe),{placeholder:"\u6587\u4EF6\u540D\u3001hash",value:E.value,"onUpdate:value":a[0]||(a[0]=t=>E.value=t)},{prefix:i(()=>[n(s(he))]),_:1},8,["value"]),n(s(F),{type:"primary",ghost:"",onClick:A},{default:i(()=>[Be]),_:1})]),_:1})]),v("div",Ne,[n(s(re),null,{default:i(()=>{var t;return[((t=m.value)==null?void 0:t.length)?(C(),_e(s(F),{key:0,type:"default"},{default:i(()=>[h(" \u7C98\u8D34\u5DF2\u526A\u5207"+pe(m.value.length)+"\u9879\u8D44\u6E90 ",1)]),_:1})):B("",!0),n(s(F),{onClick:te},{default:i(()=>[Se]),_:1}),n(s(F),{onClick:$},{default:i(()=>[xe]),_:1}),n(s(ve),{onPositiveClick:ee},{trigger:i(()=>[n(s(F),null,{default:i(()=>[Ae]),_:1})]),_:1})]}),_:1})])]),n(s(de),{style:{"max-height":"calc(100vh - 190px)"},onScroll:U},{default:i(()=>[n(s(ge),{"checked-row-keys":u.value,"onUpdate:checked-row-keys":a[1]||(a[1]=t=>u.value=t),"row-key":t=>t.id,data:f.value,size:"small",columns:T.value,bordered:!1},null,8,["checked-row-keys","row-key","data","columns"]),P.value?(C(),D("div",$e,[n(s(ye),{size:"small"}),Re])):B("",!0)]),_:1}),u.value.length?(C(),D("div",Ie,[v("div",ze,[v("div",{class:"toolbar-item",onClick:H},[n(s(b),null,{trigger:i(()=>[n(s(N),null,{default:i(()=>[n(s(ke))]),_:1})]),default:i(()=>[Me]),_:1})]),v("div",{class:"toolbar-item",onClick:J},[n(s(b),null,{trigger:i(()=>[n(s(N),null,{default:i(()=>[n(s(Fe))]),_:1})]),default:i(()=>[Le]),_:1})]),v("div",{class:"toolbar-item",onClick:a[2]||(a[2]=t=>q(u.value))},[n(s(b),null,{trigger:i(()=>[n(s(N),null,{default:i(()=>[n(s(me))]),_:1})]),default:i(()=>[Oe]),_:1})])])])):B("",!0)]))}});export{He as default};
